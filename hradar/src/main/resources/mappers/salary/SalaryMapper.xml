<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.hit.hradar.domain.salary.query.mapper.SalaryMapper">
  <select id="findAllSalaries"
    parameterType="org.hit.hradar.domain.salary.query.dto.request.SalarySearchRequest"
    resultType="org.hit.hradar.domain.salary.query.dto.SalaryDTO">
    <!-- 연봉 목록 조회 (전체)-->
    SELECT YEAR(ad.APPROVED_AT) AS year -- 년도
         , emp.EMP_ID  -- 사원 pk
         , emp.EMPLOYEE_NO -- 사번
         , emp.NAME -- 사원명
         , dep.DEPT_NAME  -- 부서명
         , cp.NAME -- 직위
         , ad.APPROVED_AT -- 승인 일시
         , emp.type -- 재직 상태
      FROM APPROVAL_DOCUMENT ad
      JOIN BASIC_SALARY_EMPLOYEE bse ON ad.DOC_ID = bse.DOC_ID
      JOIN EMPLOYEE emp ON bse.EMP_ID = emp.EMP_ID
      JOIN DEPARTMENT dep ON emp.DEPT_ID = dep.DEPT_ID
      JOIN company_position cp ON emp.POSITION_ID = cp.COM_POSITION_ID
     WHERE ad.IS_DELETED = 'N'
    <if test="deptId != null">
       AND dep.DEPT_ID = #{deptId}
    </if>
    <if test="employmentType != null">
       AND emp.TYPE = #{employmentType}
    </if>
    <if test="employeeNo != null and employeeNo != ''">
       AND emp.EMPLOYEE_NO LIKE CONCAT('%', #{employeeNo}, '%')
    </if>
    <if test="employeeName != null and employeeName != ''">
       AND emp.NAME LIKE CONCAT('%', #{employeeName}, '%')
    </if>
     ORDER BY emp.NAME ASC
  </select>

  <select id="findAllSalariesByEmpId"
    parameterType="Long"
    resultType="org.hit.hradar.domain.salary.query.dto.SalaryDTO">
    <!-- 연봉 목록 조회 (본인)-->
    SELECT YEAR(ad.APPROVED_AT) AS year -- 년도
         , emp.EMP_ID  -- 사원 pk
         , emp.EMPLOYEE_NO -- 사번
         , emp.NAME -- 사원명
         , dep.DEPT_NAME  -- 부서명
         , cp.NAME -- 직위
         , ad.APPROVED_AT -- 승인 일시
      FROM APPROVAL_DOCUMENT ad
      JOIN BASIC_SALARY_EMPLOYEE bse ON ad.DOC_ID = bse.DOC_ID
      JOIN EMPLOYEE emp ON bse.EMP_ID = emp.EMP_ID
      JOIN DEPARTMENT dep ON emp.DEPT_ID = dep.DEPT_ID
      JOIN company_position cp ON emp.POSITION_ID = cp.COM_POSITION_ID
     WHERE ad.IS_DELETED = 'N'
       AND emp.EMP_ID = #{empId}
  </select>

  <select id="findAllBasicSalaryByEmpIdAnd"
    resultType="org.hit.hradar.domain.salary.query.dto.BasicSalaryDTO">
    <!-- 연봉 히스토리 (전년도/ 올해) -->
    SELECT bse.emp_id
         , YEAR(ad.approved_at) AS year
         , ad.content           AS reason
         , LAG(bse.basic_salary) OVER (PARTITION BY bse.emp_id
                                           ORDER BY ad.approved_at
                                      ) AS prev_salary
         , bse.basic_salary     AS current_salary
         , bse.increase_rate
         , ad.approved_at
     FROM basic_salary_employee bse
     JOIN approval_document ad ON ad.doc_id = bse.doc_id
    WHERE bse.is_deleted = 'N'
      AND ad.is_deleted = 'N'
      AND ad.status = 'APPROVED'
      AND bse.EMP_ID = #{empId}
    ORDER BY ad.approved_at DESC;
  </select>


</mapper>