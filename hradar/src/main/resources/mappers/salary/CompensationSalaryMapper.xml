<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.hit.hradar.domain.salary.query.mapper.CompensationSalaryMapper">

  <select id="findAllByCompensationSalaries"
    parameterType="org.hit.hradar.domain.salary.query.dto.request.SalaryApprovalRequest"
    resultType="org.hit.hradar.domain.salary.query.dto.SalaryApprovalDTO">
    <!-- 연봉 목록 조회 (전체)-->
    SELECT YEAR(ad.CREATED_AT ) AS year
         , ad.DOC_ID
         , ad.TITLE
         , DATE_FORMAT(ad.APPROVED_AT, '%Y-%m-%d') AS approvedAt
         , cse.COMPENSATION_TYPE
         , ad.STATUS AS approvalStatus
         , emp.NAME AS writer
         , SUM(cse.AMOUNT ) AS totalSalary
         , cse.REMARK
         , count (cse.COMPENSATION_SALARY_EMPLOYEE_ID ) AS empCount
      FROM APPROVAL_DOCUMENT ad
      JOIN employee emp ON ad.WRITER_ID = emp.EMP_ID
      JOIN COMPENSATION_SALARY_EMPLOYEE cse ON ad.DOC_ID = cse.DOC_ID
     WHERE ad.IS_DELETED = 'N'
       AND ad.COMPANY_ID = #{comId}
       AND ad.DOC_TYPE = 'COMPENSATION_SALARY'
     GROUP BY ad.DOC_ID, ad.TITLE, ad.approved_at, ad.STATUS, ad.WRITER_ID, emp.NAME, cse.COMPENSATION_TYPE
     ORDER BY ad.DOC_ID DESC
  </select>

  <select id="findAllByCompensationSalariesByDocId"
    parameterType="org.hit.hradar.domain.salary.query.dto.request.SalaryApprovalRequest"
    resultType="org.hit.hradar.domain.salary.query.dto.SalaryApprovalDTO">
    <!-- 연봉 목록 조회 (전체)-->
    SELECT YEAR(ad.CREATED_AT ) AS year
          , ad.DOC_ID
         , ad.TITLE
         , DATE_FORMAT(ad.APPROVED_AT, '%Y-%m-%d') AS approvedAt
         , cse.COMPENSATION_TYPE
         , ad.STATUS AS approvalStatus
         , emp.NAME AS writer
         , SUM(cse.AMOUNT ) AS totalSalary
         , cse.REMARK
         , count (cse.COMPENSATION_SALARY_EMPLOYEE_ID ) AS empCount
      FROM APPROVAL_DOCUMENT ad
      JOIN employee emp ON ad.WRITER_ID = emp.EMP_ID
      JOIN COMPENSATION_SALARY_EMPLOYEE cse ON ad.DOC_ID = cse.DOC_ID
     WHERE ad.IS_DELETED = 'N'
       AND ad.COMPANY_ID = #{comId}
       AND ad.DOC_ID = #{docId}
       AND ad.DOC_TYPE = 'COMPENSATION_SALARY'
     GROUP BY ad.DOC_ID, ad.TITLE, ad.approved_at, ad.STATUS, ad.WRITER_ID, emp.NAME, cse.COMPENSATION_TYPE
     ORDER BY ad.DOC_ID DESC
  </select>

  <select id="findAllCompensationSalaries"
    parameterType="org.hit.hradar.domain.salary.query.dto.request.CompensationSearchRequest"
    resultType="org.hit.hradar.domain.salary.query.dto.CompensationSalaryDTO">

    SELECT YEAR(ad.CREATED_AT) AS year -- 년도
         , ad.DOC_ID
          , ad.DOC_TYPE
          , emp.EMP_ID  -- 사원 pk
          , emp.EMPLOYEE_NO -- 사번
          , emp.NAME -- 사원명
          , dep.DEPT_NAME  -- 부서명
          , cp.NAME  AS positionName-- 직위
          , emp.type AS employmentType-- 재직 상태
          , DATE_FORMAT(ad.APPROVED_AT, '%Y-%m-%d') AS approvedAt
          , cse.REMARK
          , cse.COMPENSATION_TYPE
       FROM COMPENSATION_SALARY_EMPLOYEE cse
       JOIN APPROVAL_DOCUMENT ad ON cse.DOC_ID = ad.DOC_ID AND ad.IS_DELETED = 'N'
       JOIN EMPLOYEE emp ON cse.EMP_ID = emp.EMP_ID AND emp.IS_DELETED = 'N'
       JOIN DEPARTMENT dep ON emp.DEPT_ID = dep.DEPT_ID AND dep.IS_DELETED = 'N'
       JOIN company_position cp ON emp.POSITION_ID = cp.POSITION_ID AND cp.IS_DELETED = 'N'
      WHERE cse.IS_DELETED = 'N'
        AND ad.DOC_TYPE = 'COMPENSATION_SALARY'
        AND ad.COMPANY_ID = #{comId}
        AND ad.DOC_ID = #{docId}
      <if test="deptId != null">
        AND dep.DEPT_ID = #{deptId}
      </if>
      <if test="comPositionId != null">
        AND cp.POSITION_ID = #{comPositionId}
      </if>
      <if test="employmentType != null">
        AND emp.TYPE = #{employmentType}
      </if>
      <if test="employeeNo != null and employeeNo != ''">
        AND emp.EMPLOYEE_NO LIKE CONCAT('%', #{employeeNo}, '%')
      </if>
      <if test="employeeName != null and employeeName != ''">
        AND emp.NAME LIKE CONCAT('%', #{employeeName}, '%')
      </if>
      ORDER BY emp.NAME ASC
  </select>




  <select id="findAllCompensationHistory"
    parameterType="org.hit.hradar.domain.salary.query.dto.request.CompensationHistorySearchRequest"
    resultType="org.hit.hradar.domain.salary.query.dto.CompensationHistoryDTO">

    SELECT YEAR(ad.CREATED_AT) AS year
         , cse.COMPENSATION_TYPE AS type
         , ad.TITLE
         , cse.AMOUNT
         , ad.DOC_TYPE
         , cse.RATE
         , DATE_FORMAT(ad.APPROVED_AT, '%Y-%m-%d') AS approvedAt
         , cse.EMP_ID
         , ad.STATUS AS approvalStatus
         , cse.REMARK
      FROM COMPENSATION_SALARY_EMPLOYEE cse
      JOIN APPROVAL_DOCUMENT ad ON cse.DOC_ID = ad.DOC_ID AND ad.IS_DELETED = 'N'
     WHERE cse.IS_DELETED = 'N'
       AND ad.DOC_TYPE = 'COMPENSATION_SALARY'
       AND ad.COMPANY_ID = #{comId}
       AND cse.EMP_ID = #{empId}
    <if test="year != null">
       AND YEAR(ad.CREATED_AT) = #{year}
    </if>
    <if test="type != null">
       AND cse.COMPENSATION_TYPE = #{type}
    </if>
     ORDER BY ad.DOC_ID DESC
  </select>



  <select id="findCompensationSalaries"
    parameterType="org.hit.hradar.domain.salary.query.dto.request.CompensationSearchRequest"
    resultType="org.hit.hradar.domain.salary.query.dto.CompensationSalaryDTO">

    SELECT ad.TITLE
         , SUM( CASE WHEN cse.COMPENSATION_TYPE = 'BONUS' THEN cse.AMOUNT
                     ELSE 0
                 END
         ) AS totalBonus
         , SUM( CASE WHEN cse.COMPENSATION_TYPE = 'INCENTIVE' THEN cse.AMOUNT
                     ELSE 0
                 END
         ) AS totalIncentive
         , SUM( CASE WHEN cse.COMPENSATION_TYPE = 'PERFORMANCE' THEN cse.AMOUNT
                     ELSE 0
                 END
         ) AS totalPerformance
         , SUM( CASE WHEN cse.COMPENSATION_TYPE = 'ALLOWANCE' THEN cse.AMOUNT
                     ELSE 0
                 END
         ) AS totalAllowance
         , SUM(cse.AMOUNT) AS totalCompensation
      FROM COMPENSATION_SALARY_EMPLOYEE cse
      JOIN APPROVAL_DOCUMENT ad ON cse.DOC_ID = ad.DOC_ID AND ad.IS_DELETED  = 'N'
     WHERE cse.IS_DELETED = 'N'
       AND ad.STATUS = 'APPROVED'
       AND ad.DOC_TYPE = 'COMPENSATION_SALARY'
       AND ad.APPROVED_AT <![CDATA[>=]]> #{startDate}
       AND ad.APPROVED_AT <![CDATA[<]]> DATE_ADD(#{endDate}, INTERVAL 1 DAY)
       AND ad.COMPANY_ID = #{comId}
    <if test="empId != null">
       AND cse.EMP_ID = #{empId}
    </if>
     GROUP BY ad.DOC_ID , ad.TITLE
  </select>

</mapper>