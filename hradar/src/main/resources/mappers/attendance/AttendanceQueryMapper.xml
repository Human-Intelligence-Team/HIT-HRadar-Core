<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.hit.hradar.domain.attendance.query.mapper.AttendanceQueryMapper">

  <!-- 근태 목록 조회 (기간) -->
  <select id="findAttendanceList"
    parameterType="org.hit.hradar.domain.attendance.query.dto.request.AttendanceListQueryRequest"
    resultType="org.hit.hradar.domain.attendance.query.dto.response.AttendanceListResponseDto">

    SELECT
    a.work_date AS workDate,
    a.emp_id AS empId,
    e.name AS empName,
    d.dept_name AS departmentName,
    a.work_type AS workType,
    a.status AS status,
    MIN(w.start_at) AS checkInTime,
    MAX(w.end_at) AS checkOutTime,
    COALESCE(
    SUM(TIMESTAMPDIFF(MINUTE, w.start_at, w.end_at)), 0
    ) AS totalWorkMinutes
    FROM attendance a
    JOIN employee e ON a.emp_id = e.emp_id
    LEFT JOIN department d ON e.dept_id = d.dept_id
    LEFT JOIN attendance_work_log w
    ON w.attendance_id = a.attendance_id
    AND w.is_deleted = 'N'
    WHERE a.emp_id = #{targetEmpId}
    AND a.work_date BETWEEN #{fromDate} AND #{toDate}
    GROUP BY
    a.work_date,
    a.emp_id,
    e.name,
    d.dept_name,
    a.work_type,
    a.status
    ORDER BY a.work_date ASC
  </select>

  <!-- WorkLog 타임라인 resultMap -->
  <resultMap id="WorkLogTimelineResultMap"
    type="org.hit.hradar.domain.attendance.query.dto.response.WorkLogTimelineItemDto">
    <result property="workLogType" column="work_log_type"/>
    <result property="startAt" column="start_at"/>
    <result property="location" column="location"/>
  </resultMap>

  <!-- 근태 상세 resultMap -->
  <resultMap id="AttendanceDetailResultMap"
    type="org.hit.hradar.domain.attendance.query.dto.response.AttendanceDetailResponseDto">

    <id property="attendanceId" column="attendance_id"/>
    <result property="empId" column="emp_id"/>
    <result property="empName" column="emp_name"/>
    <result property="deptId" column="dept_id"/>
    <result property="workDate" column="work_date"/>
    <result property="status" column="status"/>
    <result property="workType" column="work_type"/>
    <result property="workPlace" column="work_place"/>
    <result property="checkInTime" column="check_in_time"/>
    <result property="checkOutTime" column="check_out_time"/>
    <result property="totalWorkMinutes" column="total_work_minutes"/>

    <collection property="timeline"
      resultMap="WorkLogTimelineResultMap"/>
  </resultMap>


  <!-- 근태 상세 조회 (하루) -->
  <select id="findAttendanceDetail"
    parameterType="org.hit.hradar.domain.attendance.query.dto.request.AttendanceDetailQueryRequest"
    resultMap="AttendanceDetailResultMap">

    SELECT
    a.attendance_id
    , a.work_date
    , a.status
    , e.dept_id
    , a.work_type
    , (SELECT location FROM attendance_work_log
       WHERE attendance_id = a.attendance_id AND is_deleted = 'N'
       ORDER BY start_at DESC LIMIT 1) AS work_place
    , w.work_log_type
    , w.start_at
    , w.location
    , MIN(w.start_at) OVER () AS check_in_time
    , CASE
        WHEN SUM(CASE WHEN w.end_at IS NULL THEN 1 ELSE 0 END) OVER () > 0 THEN NULL
        ELSE MAX(w.end_at) OVER ()
      END AS check_out_time
    , COALESCE(
    SUM(TIMESTAMPDIFF(MINUTE, w.start_at, w.end_at)) OVER (), 0
    ) AS total_work_minutes
    FROM attendance a
    JOIN employee e ON a.emp_id = e.emp_id
    LEFT JOIN attendance_work_log w
    ON w.attendance_id = a.attendance_id
    AND w.is_deleted = 'N'
    WHERE a.emp_id = #{targetEmpId}
    AND a.work_date = #{workDate}
    ORDER BY w.start_at ASC

  </select>

  <select id="findAttendanceCalendar"
    parameterType="org.hit.hradar.domain.attendance.query.dto.request.AttendanceListQueryRequest"
    resultType="org.hit.hradar.domain.attendance.query.dto.response.AttendanceCalendarItemDto">

    SELECT
      a.attendance_id AS attendanceId,
      a.emp_id        AS empId,
      e.name          AS empName,
      a.work_date     AS workDate,
      a.work_type     AS workType,
      CASE
        WHEN a.status = 'LEAVE' THEN '휴가'
        WHEN EXISTS (
          SELECT 1 FROM attendance_work_log w
          WHERE w.attendance_id = a.attendance_id AND w.end_at IS NULL AND w.is_deleted = 'N'
        ) THEN
          CASE
            WHEN a.work_type = 'REMOTE' THEN '재택'
            WHEN a.work_type = 'OUTSIDE' THEN '외근'
            ELSE '출근'
          END
        WHEN EXISTS (
          SELECT 1 FROM attendance_work_log w
          WHERE w.attendance_id = a.attendance_id AND w.is_deleted = 'N'
        ) THEN '퇴근'
        ELSE '미출근'
      END AS status,
      d.dept_name     AS departmentName,
      p.name          AS jobTitle,
      (
        SELECT COALESCE(SUM(TIMESTAMPDIFF(MINUTE, w.start_at, IFNULL(w.end_at, NOW()))), 0)
        FROM attendance_work_log w
        WHERE w.attendance_id = a.attendance_id AND w.is_deleted = 'N'
      ) AS totalWorkMinutes,
      (
        SELECT w.location
        FROM attendance_work_log w
        WHERE w.attendance_id = a.attendance_id AND w.is_deleted = 'N'
        ORDER BY w.start_at DESC
        LIMIT 1
      ) AS location
    FROM attendance a
    JOIN employee e ON a.emp_id = e.emp_id
    LEFT JOIN department d ON e.dept_id = d.dept_id
    LEFT JOIN company_position p ON e.position_id = p.position_id
   WHERE a.is_deleted = 'N'
   <if test="targetEmpId != null">
     AND a.emp_id = #{targetEmpId}
   </if>
   <if test="targetDeptId != null">
     AND e.dept_id = #{targetDeptId}
   </if>
    AND a.work_date BETWEEN #{fromDate} AND #{toDate}
   ORDER By a.work_date ASC, e.name ASC

  </select>

</mapper>
