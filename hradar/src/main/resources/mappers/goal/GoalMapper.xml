<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.hit.hradar.domain.goal.query.mapper.GoalMapper">

    <!-- 1) Goal 전체 조회: 트리 구조를 만들기 위한 원본 데이터 -->
    <select id="selectGoals"
            resultType="org.hit.hradar.domain.goal.query.dto.response.GoalNodeResponseDto">
        SELECT
        goal_id             AS goalId,          <!-- Goal PK -->
        parent_goal_id      AS parentGoalId,    <!-- 트리 조립용 부모 ID -->
        goal_depth          AS depth,           <!-- LEVEL_1/2/3 -->
        goal_type           AS goalType,        <!-- KPI / OKR -->
        goal_title          AS title,           <!-- 목표명 -->
        goal_approve_status AS approveStatus    <!-- 승인상태(조회 화면 표시용) -->
        FROM goal
        WHERE is_deleted = 'N'
        AND goal_dept_id = #{departmentId}
        ORDER BY goal_depth, goal_id
    </select>

    <!-- 2) KPI 목록 조회: goalIds에 달린 KPI 정의값(시작/목표) 가져오기 -->
    <select id="selectKpis"
            resultType="org.hit.hradar.domain.goal.query.dto.response.KpiProgressResponseDto">
        SELECT
        kpi_id          AS kpiId,
        goal_id         AS goalId,
        kpi_metric_name AS metricName,
        kpi_start_value AS startValue,
        kpi_target_value AS targetValue
        FROM kpi_detail
        WHERE is_deleted = 'N'
        AND goal_id IN
        <foreach collection="goalIds" item="id" open="(" close=")" separator=",">
            #{id}
        </foreach>
    </select>

    <!-- 3) KPI 누적합 조회: KPI별 SUM(log_value)를 한 번에 가져옴 (대시보드 바 그래프용) -->
    <select id="selectKpiCurrentSums"
            resultType="org.hit.hradar.domain.goal.query.dto.response.KpiCurrentSumRow">
        SELECT
        kpi_id AS kpiId,
        SUM(log_value) AS currentValue
        FROM kpi_progress_log
        WHERE is_deleted = 'N'
        AND kpi_id IN
        <foreach collection="kpiIds" item="id" open="(" close=")" separator=",">
            #{id}
        </foreach>
        GROUP BY kpi_id
    </select>

    <!-- 4) KR 목록 조회: goalIds에 달린 KR(내용) 가져오기 -->
    <select id="selectKrs"
            resultType="org.hit.hradar.domain.goal.query.dto.response.KrProgressResponseDto">
        SELECT
        key_result_id      AS keyResultId,
        goal_id            AS goalId,
        key_result_content AS content
        FROM okr_key_result
        WHERE is_deleted = 'N'
        AND goal_id IN
        <foreach collection="goalIds" item="id" open="(" close=")" separator=",">
            #{id}
        </foreach>
    </select>

    <!-- 5) KR 최신 진척률: 각 KR별 가장 최근(created_at) 로그의 current_progress만 가져오기 -->
    <select id="selectKrLatestProgress"
            resultType="org.hit.hradar.domain.goal.query.dto.response.KrLatestProgressRow">
        SELECT
        p.key_result_id     AS keyResultId,
        p.current_progress  AS latestProgress
        FROM okr_progress_log p
        INNER JOIN (
        SELECT
        key_result_id,
        MAX(created_at) AS maxCreatedAt     <!-- 최신 로그 기준 -->
        FROM okr_progress_log
        WHERE is_deleted = 'N'
        AND key_result_id IN
        <foreach collection="krIds" item="id" open="(" close=")" separator=",">
            #{id}
        </foreach>
        GROUP BY key_result_id
        ) lastLog
        ON p.key_result_id = lastLog.key_result_id
        AND p.created_at = lastLog.maxCreatedAt
        WHERE p.is_deleted = 'N'
    </select>

</mapper>
