<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.hit.hradar.domain.goal.query.mapper.GoalDetailMapper">
    <select id="findGoalDetail"
            parameterType="long"
            resultType="org.hit.hradar.domain.goal.query.dto.response.GoalDetailResponseDto">
        /*Goal 기본 정보*/
        SELECT
        g.goal_id             AS goalId,
        g.parent_goal_id      AS parentGoalId,
        g.goal_depth          AS depth,
        g.goal_scope          AS scope,
        g.goal_type           AS type,
        g.goal_title          AS title,
        g.goal_description    AS description,
        g.goal_approve_status AS approveStatus,
        g.goal_start_date     AS startDate,
        g.goal_end_date       AS endDate,
        g.goal_dept_id        AS departmentId,

        /*Goal 진행률 계산*/
        CASE
        /* KPI Goal */
        WHEN g.goal_type = 'KPI' THEN
        COALESCE((
        SELECT ROUND(AVG(kpi_calc.kpi_progress), 2)
        FROM (
        SELECT
        kd.kpi_id,
        CASE
        WHEN (kd.kpi_target_value - kd.kpi_start_value) = 0 THEN 0
        ELSE
        LEAST(
        100,
        GREATEST(
        0,
        (
        (
        (kd.kpi_start_value + IFNULL(SUM(kpl.log_value), 0))
        - kd.kpi_start_value
        )
        / (kd.kpi_target_value - kd.kpi_start_value)
        ) * 100
        )
        )
        END AS kpi_progress
        FROM kpi_detail kd
        LEFT JOIN kpi_progress_log kpl
        ON kpl.kpi_id = kd.kpi_id
        AND kpl.is_deleted = 'N'
        WHERE kd.goal_id = g.goal_id
        AND kd.is_deleted = 'N'
        GROUP BY kd.kpi_id, kd.kpi_start_value, kd.kpi_target_value
        ) kpi_calc
        ), 0)

        /* KR Goal */
        WHEN g.goal_type = 'OKR' THEN
        COALESCE((
        SELECT ROUND(AVG(
        CASE
        WHEN kr.is_achieved = 'Y' THEN 100
        ELSE 0
        END
        ), 2)
        FROM okr_key_result kr
        WHERE kr.goal_id = g.goal_id
        AND kr.is_deleted = 'N'
        ), 0)

        ELSE 0
        END AS progressRate

        FROM goal g
        WHERE g.goal_id = #{goalId}
        AND g.is_deleted = 'N'

    </select>

</mapper>