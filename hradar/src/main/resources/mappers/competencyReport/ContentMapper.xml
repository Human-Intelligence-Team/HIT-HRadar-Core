<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.hit.hradar.domain.competencyReport.query.mapper.ContentMapper">

  <select id="findAllContents"
    parameterType="org.hit.hradar.domain.competencyReport.query.dto.request.ContentSearchRequest"
    resultType="org.hit.hradar.domain.competencyReport.query.dto.ContentRowDTO">
    <!-- 학습 컨텐츠 목록 조회 -->
    SELECT ct.CONTENT_ID        AS contentId
         , ct.LEARNING_TIME     AS learningTime
         , ct.LEVEL             AS LEVEL
         , levelCode.CUSTOM_CODE AS levelCode
         , levelCode.CUSTOM_NAME  AS levelName
         , ct.RESOURCE_PATH     AS resourcePath
         , ct.TITLE             AS title
         , ct.TYPE              AS type
         , typeCode.CUSTOM_CODE AS typeCode
         , typeCode.CUSTOM_NAME  AS typeName
         , ctt.TAG_ID           AS tagId
         , ct.IS_DELETED        AS isDeleted
      FROM CONTENT ct
      JOIN CONTENT_TAG ctt
        ON ct.CONTENT_ID = ctt.CONTENT_ID
      JOIN COMPETENCY_REPORT_CUSTOM_CODE typeCode
        ON ct.TYPE = typeCode.CUSTOM_CODE_ID
       AND typeCode.IS_DELETED = 'N'
      JOIN COMPETENCY_REPORT_CUSTOM_CODE levelCode
        ON ct.LEVEL = levelCode.CUSTOM_CODE_ID
       AND levelCode.IS_DELETED = 'N'
     WHERE ct.IS_DELETED = 'N'
    <if test="level != null">
       AND ct.LEVEL = #{level}
    </if>
    <if test="title != null and title != ''">
       AND ct.TITLE LIKE CONCAT('%', #{title}, '%')
    </if>
    <if test="type != null">
       AND ct.TYPE = #{type}
    </if>
    <if test="learningTime != null">
      AND ct.LEARNING_TIME &lt;= #{learningTime}
    </if>
    <if test="tags != null and tags.size() > 0">
        AND tg.TAG_ID IN
      <foreach collection="tags" item="id" open="(" separator="," close=")">
        #{id}
      </foreach>
    </if>

  </select>
  <select id="findContentByContentId"
    parameterType="Long"
    resultType="org.hit.hradar.domain.competencyReport.query.dto.ContentDTO">
    <!-- 학습컨텐츠 상세 조회 -->
    SELECT ct.CONTENT_ID      AS contentId
         , ct.TITLE           AS title
         , ct.TYPE            AS type
         , typeCode.CUSTOM_CODE AS typeCode
         , typeCode.CUSTOM_NAME  AS typeName
         , ct.LEVEL           AS level
         , levelCode.CUSTOM_CODE AS levelCode
         , levelCode.CUSTOM_NAME  AS levelName
         , ct.LEARNING_TIME   AS learningTime
         , ct.RESOURCE_PATH   AS resourcePath
         , ct.NOTES		        AS notes
         , ct.IS_DELETED      AS isDeleted
         , ct.CREATED_AT 	    AS createdAt
         , ct.UPDATED_AT 	    AS updatedAt
      FROM CONTENT ct
      JOIN COMPETENCY_REPORT_CUSTOM_CODE typeCode
        ON ct.TYPE = typeCode.CUSTOM_CODE_ID
       AND typeCode.IS_DELETED = 'N'
      JOIN COMPETENCY_REPORT_CUSTOM_CODE levelCode
        ON ct.LEVEL = levelCode.CUSTOM_CODE_ID
       AND levelCode.IS_DELETED = 'N'
     WHERE ct.CONTENT_ID = #{contentId}

  </select>

  <select id="findContentByCompetencyReportId"
    parameterType="Long"
    resultType="org.hit.hradar.domain.competencyReport.query.dto.ContentRowDTO">
    <!-- 학습 컨텐츠 목록, 태그 목록 조회 -->
    SELECT rc.COMPETENCY_REPORT_ID
         , ct.CONTENT_ID
         , ct.TITLE
         , ct.TYPE            AS type
         , ct.LEVEL           AS level
         , ct.LEARNING_TIME
         , ct.RESOURCE_PATH   AS resourcePath
         , tg.TAG_ID
         , tg.TAG_NAME
      FROM report_content rc
      JOIN CONTENT ct ON rc.CONTENT_ID = ct.CONTENT_ID
      JOIN CONTENT_TAG ctt ON rc.CONTENT_ID = ct.CONTENT_ID
      JOIN TAG tg ON ctt.TAG_ID = tg.TAG_ID
     WHERE COMPETENCY_REPORT_ID = #{competencyReportId}
       AND ct.IS_DELETED = "N"
     ORDER BY ct.CONTENT_ID asc
  </select>
</mapper>
